{% from 'game/index.html.twig' import get_path %}

{% for game in games %}
  {# Fetch the data into a temp object to apply cutom formatting #}
  {% set gameData = {
    releaseYear: game.releaseYear,
    fullPrice: game.fullPrice > 0
      ? (game.fullPrice / 100)|format_currency(env.app.currency, { decimal_always_shown: true, fraction_digit: 2 })
      : game.fullPrice|fmt_full_price(env.app.locale),
    developers: game.developers,
    genres: game.genres,
    description: game.description,
  } %}

  {# Each game is displayed on a "card" containing all the data #}
  <div class="card-max-auto card-max-md-none mx-auto my-3 rounded-3 border overflow-hidden">
    {# Card title bar with the the title on one side, and 3 infos on the other side (or on top of each other on small screen) #}
    <div class="row gx-0 bg-primary-subtle border-bottom text-center">
      {# Actual title with the edit button #}
      <div class="col-12 border-bottom col-md border-bottom-md-0">
        <div class="d-flex py-2 px-2 ps-md-3 justify-content-center justify-content-md-start align-items-center">
          <h5 class="mb-0 p-0">
            {{ game.name }}
            <a class="fs-6 p-0 link-secondary" href="{{ path('game_edit', { id: game.id }) }}" data-turbo-frame="_top"><span class="bi bi-pen ps-1"></span></a>
          </h5>
        </div>
      </div>
      {# 3 piece of information : player who have written a review, avg hour spent, avg mark #}
      <div class="col-12 d-flex align-items-center col-md-auto">
        <div class="flex-even-1 py-1 px-2 py-md-2 d-flex justify-content-center align-items-center flex-even-md-0">
          <img src=" {{ asset('build/bibi.jpg') }}" class="rounded-circle mx-1 app-avatar-card" alt="TODO" />
          <img src=" {{ asset('build/bibi.jpg') }}" class="rounded-circle mx-1 app-avatar-card" alt="TODO" />
          <img src=" {{ asset('build/bibi.jpg') }}" class="rounded-circle mx-1 app-avatar-card" alt="TODO" />
          <img src=" {{ asset('build/bibi.jpg') }}" class="rounded-circle mx-1 app-avatar-card" alt="TODO" />
        </div>
        <div class="flex-even-1 py-1 px-2 py-md-2 border-start flex-even-md-0">
          1500
          <span class="fa-regular fa-hourglass-half fa-sm"></span>
        </div>
        <div class="flex-even-1 py-1 px-2 py-md-2 border-start flex-even-md-0">
          6 ðŸŒ­
        </div>
      </div>
    </div>

    {# Card body divided in two parts : some generic information, and the review of each player #}
    <div class="row py-0 g-0 px-0 bg-body-tertiary">
      {# Card body - first part : generic information #}
      <div class="col-12 px-0 col-md-6 card-max-md-auto border-bottom border-end-md border-bottom-md-0">
        <div class="mx-auto">
          {# Collapse button for small screen #}
          {% set collapseId = 'collapseInformations' ~ game.id %}
          <button class="btn btn-outline-secondary d-flex w-100 justify-content-center align-items-center border-0 border-bottom app-no-border-bottom rounded-0 py-1 my-0 dropdown-toggle app-dropdown-left app-dropdown-smooth d-md-none"
            data-bs-toggle="collapse"
            data-bs-target="#{{ collapseId }}"
            aria-expanded="false"
            aria-controls="{{ collapseId }}">
            <h6 class="m-0 p-0 fs-5">
              {{ 'game.index.card.informations'|trans }}
            </h6>
          </button>

          <div class="row p-0 m-0 collapse d-md-flex" id="{{ collapseId }}">
            {# Image from the URL or a placeholder if empty #}
            <div class="col-12 px-0 border-bottom">
              <div class="mx-auto">
                {% if game.imgUrl is not empty %}
                  <img src="{{ game.imgUrl }}" class="app-card-img-fit" alt="TODO" />
                {% else %}
                  <div class="bi bi-image text-center app-card-img-fit app-card-img-missing bg-body-secondary"></div>
                {% endif %}
              </div>
            </div>

            {# All other information #}
            {% for field, value in gameData %}
              <div class="col-4 py-1 px-1 text-end text-truncate {{ field != 'description' ? 'border-bottom' : '' }}">
                <span class="fst-italic fs-6 fw-light">{{ ('game.label.' ~ field)|trans({ }, 'validators') }}</span>
              </div>
              <div class="col-8 py-1 text-start {{ (field not in ['genres', 'description'] ? 'text-truncate') ~ ' ' ~ (field != 'description' ? 'border-bottom') }}">
                {{ value|default('-') }}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {# Card body - second part : all reviews #}
      <div class="col-12 px-0 col-md">
        <div class="mx-auto">
          {# Collapse button for small screen #}
          {% set collapseId = 'collapseReviews' ~ game.id %}
          <button class="btn btn-outline-secondary d-flex w-100 justify-content-center align-items-center border-0 border-bottom app-no-border-bottom rounded-0 py-1 my-0 dropdown-toggle app-dropdown-left app-dropdown-smooth d-md-none"
            data-bs-toggle="collapse"
            data-bs-target="#{{ collapseId }}"
            aria-expanded="false"
            aria-controls="{{ collapseId }}">
            <h6 class="m-0 p-0 fs-5">
              {{ 'game.index.card.reviews'|trans }}
            </h6>
          </button>

          {# Reviews content #}
          <div class="row p-0 m-0 collapse d-md-flex" id="{{ collapseId }}">
            <div class="col-12 p-2">
              At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint
              occaecati cupiditate non provident.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endfor %}

{% if hasMore %}
  <div class="text-center"
    {{ stimulus_controller('load-more', { url: get_path(searchParam.sortField, searchParam.sortOrder, searchParam.firstResult + env.app.max_results)|trim, lazy: true }) }}>
    <button class="btn btn-outline-secondary" data-load-more-target="button remove">{{ 'form.button.showMore'|trans }}</button>
    <span class="fs-4 text-muted" data-load-more-target="spinner"></span>
  </div>
{% endif %}
