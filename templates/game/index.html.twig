{% extends 'base.html.twig' %}

{# Macro to lighten the code to generate path with query params for the sort #}
{% macro get_path(sortField, sortOrder, firstResult) %}
  {{ path(app.current_route, { sortField: sortField, sortOrder: sortOrder, firstResult: firstResult })|raw }}
{% endmacro %}

{% set title = 'game.index.title'|trans %}
{% set sortFieldPossible = ['name', 'avgRating', 'totHourSpend', 'minFirstPlay'] %}
{% set sortOrderButton %}
  <a role="button" class="btn btn-outline-secondary app-btn-border-light" href="{{ _self.get_path(searchParam.sortField, searchParam.sortOrder == 'asc' ? 'desc' : 'asc', 0) }}">
    <span class="bi bi-arrow-{{ searchParam.sortOrder == 'asc' ? 'up' : 'down' }}"></span>
  </a>
{% endset %}

{% block main %}
  <section>
    <div class="container">
      {# Redefine the flashes with the same width as the cards #}
      <div class="mx-auto card-max-auto card-max-md-none">
        {{ block('flash', 'theme/flash.html.twig') }}
      </div>

      {# Button to add a new game #}
      <div class="mx-auto card-max-auto card-max-md-none pb-3">
        <a href="{{ path('game_new') }}" class="btn btn-primary" data-turbo-frame="_top">
          <span class="bi bi-plus-square-fill me-md-1"></span>
          <span class="d-none d-md-inline">{{ 'game.index.button.addGame'|trans }}</span>
        </a>
      </div>

      {# Turboframe to refresh only the main section when sorting the results #}
      <turbo-frame id="main-section">
        {# Before the first card : field to sort on the left, button to add new game on the right #}
        <div class="d-flex card-max-auto align-items-center justify-content-between card-max-md-none mx-auto">
          {# Fields to sort on large screen : independant buttons for each possibility + asc/desc button #}
          <div class="d-none d-md-block">
            <div class="input-group" role="group" aria-labelledby="sortFieldButtons">
              <label class="input-group-text" id="sortFieldButtons">{{ 'form.button.sortBy'|trans }}</label>
              {% for newSortField in sortFieldPossible %}
                <a role="button"
                  class="btn btn-outline-secondary app-btn-border-light {{ searchParam.sortField == newSortField ? 'active' }}"
                  href="{{ _self.get_path(newSortField, searchParam.sortOrder, 0) }}">
                  {{ ('game.index.sort.' ~ newSortField)|trans }}
                </a>
              {% endfor %}
              {{ sortOrderButton }}
            </div>
          </div>

          {# Fields to sort on small screen : on select with all possibilities + asc/desc button #}
          <div class="d-md-none">
            <div class="input-group">
              <label class="input-group-text" for="sortFieldOptions">{{ 'form.button.sortBy'|trans }}</label>
              <select class="form-select" id="sortFieldOptions" {{ stimulus_controller('sort-select') }}>
                {% for newSortField in sortFieldPossible %}
                  <option value="{{ _self.get_path(newSortField, searchParam.sortOrder, 0) }}" {{ searchParam.sortField == newSortField ? 'selected="selected"' }}>
                    {{ ('game.index.sort.' ~ newSortField)|trans }}
                  </option>
                {% endfor %}
              </select>
              {{ sortOrderButton }}
            </div>
          </div>

          <div class="ms-2">
            <div class="input-group" role="group" aria-labelledby="filterFieldButtons">
              <label class="input-group-text" id="filterFieldButtons">{{ 'form.button.filterBy'|trans }}</label>
              {% set filterId = 'dropdownFilter' %}
              <button type="button"
                class="btn btn-outline-secondary app-btn-border-light dropdown-toggle app-dropdown-left app-dropdown-smooth"
                data-bs-toggle="dropdown"
                data-bs-target="#{{ filterId }}"
                data-bs-auto-close="outside"
                aria-expanded="false"
                aria-haspopup="true">
                Joueurs
              </button>
              <ul id="{{ filterId }}" class="dropdown-menu dropdown-menu-end">
                {% for user in distinctUsers|sort((a, b) => a.username <=> b.username) %}
                  <li>
                    <div class="dropdown-item">
                      <input class="form-check-input" type="checkbox" value="{{ user.id }}" id="{{ filterId ~ user.id }}" {{ user.id in searchParam.filterValues ? 'checked' }} />
                      <label class="form-check-label w-100" for="{{ filterId ~ user.id }}">
                        <img src="{{ HubUrlGenerator.generateRoot(user.avatarPath) }}"
                          class="rounded-circle img-fluid app-avatar-card"
                          alt="{{ 'aria.avatar'|trans({ name: user.username }) }}" />
                        <span class="ms-1">{{ user.username }}</span>
                      </label>
                    </div>
                  </li>
                {% endfor %}
                {# <li><hr class="dropdown-divider" /></li> #}
                <li>
                  <div class="dropdown-item text-center">
                    <a role="button" class="btn btn-outline-secondary">{{ 'form.button.apply'|trans }}</a>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        {# Include the template to render the card of each game + show more button #}
        {{ include('game/list.html.twig') }}
      </turbo-frame>
    </div>
  </section>
{% endblock %}
